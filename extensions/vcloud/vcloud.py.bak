#########################################################################
# Copyright 2011 Cloud Sidekick
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#########################################################################

try:
    import xml.etree.cElementTree as ET
except (AttributeError, ImportError):
    import xml.etree.ElementTree as ET
try:
    ET.ElementTree.iterfind
except AttributeError as ex:
    del(ET)
    import catoxml.etree.ElementTree as ET

from catotaskengine import classes
from vcloudpy import vcloudpy

def vcloud_connect(TE, step):

    cloud_name = TE.get_command_params(step.command, "endpoint_name")[0]
    cloud_name = TE.replace_variables(cloud_name)

    if not len(cloud_name):
        cloud_name = TE.cloud_name
    try:
        cloud = TE.cloud_conns[cloud_name]
    except KeyError as ex:
        cloud = classes.Cloud(cloud_name)
        TE.cloud_conns[cloud_name] = cloud

    print "cloudname = %s" % (cloud_name)

    if cloud.provider != "vCloud":
        msg = "The endpoint named cloud_name is not a vCloud configured endpoint" % (cloud_name)
        raise Exception(msg)

    if not cloud.conn:
        cloud.conn = vcloudpy.VCloudConn(TE.cloud_login_id, TE.cloud_login_password, cloud.url, debug=False)

    return cloud


def vcloud_call(te, step):

    cloud = vcloud_connect(te, step)
    path, meth_or_href, action, data, type, out_var = te.get_command_params(step.command, "path", "method_or_href", 
        "action", "data", "content_type", "output_var")[:]
    path = te.replace_variables(path) 
    data = te.replace_variables(data) 
    type = te.replace_variables(type) 

    if not len(type):
        type = None
    if not len(data):
        data = None

    print meth_or_href

    if meth_or_href == "href":
        result = cloud.conn.make_href_request_path(path, action, data=data, type=type)
    else:
        result = cloud.conn.make_method_request(path, action)

    if len(out_var):
        te.rt.set(out_var, result)

def vcloud_parse(te, step):

    path, xml = te.get_command_params(step.command, "path", "xml")[:]
    path = te.replace_variables(path) 
    xml = te.replace_variables(xml) 
    attribs = te.get_node_list(step.command, "attribs/attrib", "name", "variable")
    elems = te.get_node_list(step.command, "elems/elem", "name", "variable")
    
    variable_list = {}
    attrib_list = []
    for a in attribs:
        if len(a[0]) and len(a[1]):
            attrib_list.append(a[0])
            variable_list[a[0]] = a[1]
    elem_list = []
    for e in elems:
        if len(e[0]) and len(e[1]):
            elem_list.append(e[0])
            variable_list.append(e[1])
            
    result = vcloudpy.get_node_values(xml, path, attribs=attrib_list, elems=elem_list)
    msg = "vcloud parse\n%s" % (result)
    te.insert_audit(step.function_name, msg, "")

    ii = 0
    for row in result:
        ii =+ 1
        for k,v in variable_list.iteritems():
            if ii == 1:
                te.rt.clear(v)
            print "key %s, variable %s" % (k, v)
            if k in row:
                print "setting %s to %s" % (v,  row[k])
                te.rt.set(v, row[k])
